---
layout: post
title: Malware Traffic Analyisi!
---

Network traffic analysis is a great starting point to investigate incidents where it can provide you with information on how the adversary gets to manage or has access to your organisation.

In order to analyse the network traffic we can use wireshark to analyse based on the initial information we have.



### Scenario 1:

- The SOC manager has provided you with a pcap file and asked you to do an analysis based on an employee in the Finance department who reported unexpected behaviour from his machine. also the system admin provides you with the IP of the infected machine.

- to start analysis pcap file you always start with what you know and that is IP address of infected machine.

- filter down your traffic to only see all the communications that the infected machine did with the following display filter in wireshark:

      <code>  ip.addr==MachineIP <code/>

after that you can follow the TCP/HTTP stream to check HTTP request to check if the user has made any suspicious request, then we manage to conclude that the user machine has downloaded files using the following URL:
<br/>
    ![_config.yml]({{ site.baseurl }}/images/fig1.png)


### TIPs:

But wait, why the request made without the User-Agent header?, that may lead us to the idea that the request was made with another piece of malware “Loader” that already exists in our environment.

The downloaded file is a windows executable file as shown in Fig 1. But we can confirm that by exporting the file from traffic as raw dump as the following (see Fig 2):
<br/>
    ![_config.yml]({{ site.baseurl }}/images/fig2.png)


Then remove the highlighted part to get the actual executable data. Then find the hash of that file using the hashmyfile tool.

The next step we need to know is if this machine made calls for the internet, because when the malware got into your network it had to connect to its C2 server to get commands from there.

We will exclude the TCP flags and focus on HTTP and DNS query using the following filter: !(tcp). (see Fig 3)

Fig3: shows that the infected host made extensive DNSqueries in order to CONNECT to its C2 server. We can export these domains as IOCs and block them to outbound traffic.<br/>
    ![_config.yml]({{ site.baseurl }}/images/fig3.png)

The next thing we need to know is if the malware intended to spread over the network by connecting to RFC1918.

Using the following wireshark filter:

ip.src == <INFEDED_MACHINE> && (ip.addr == 10[.]0[.]0[.]0/8 || ip.addr == 172[.]16[.]0[.]0/12 || ip.addr ==192[.]168[.]0[.]0/16 || ip.dst ==12[.]0[.]0[.]0/8)
&& !(icmp)

and we didnt see any enternal connection from the infected machine.

now we can show our findings to the team to make further invistigation by looking and the host level log data.


IOCs:

MD5: <REDECTED>
SHA1: <REDECTED>
SHA256: <REDECTED>
IP Address: <REDECTED>
domain: <REDECTED>
Activate to view large.

![_config.yml]({{ site.baseurl }}/images/config.png)

The easiest way to make your first post is to edit this one. Go into /_posts/ and update the Hello World markdown file. For more instructions head over to the [Jekyll Now repository](https://github.com/barryclark/jekyll-now) on GitHub.
